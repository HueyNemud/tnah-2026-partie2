
if __name__ == "__main__":
    """
    POINT D'ENTRÉE DU SCRIPT
    Ce bloc orchestre l'enrichissement des données : il lit les fichiers locaux,
    va chercher les informations manquantes à la BnF, et fusionne le tout.
    """

    # --- ÉTAPE 1 : RÉGLAGES ET CHEMINS (CONFIGURATION)
    base_dir = Path(__file__).parent
    input_dir = base_dir / "photographies"
    output_dir = base_dir / "photographies_avec_themes"

    # Sécurité : limiter le nombre de requêtes pour les tests (None pour tout traiter)
    graph_processing_limit = 1

    # --- ÉTAPE 2 : PRÉPARATION DES OUTILS (INITIALISATION)

    # On s'assure que le dossier de sortie existe pour ne pas faire planter le script
    os.makedirs(output_dir, exist_ok=True)

    # Connexion au point d'accès SPARQL de la BnF
    databnf = setup_bnf_sparql_wrapper()

    # On récupère la liste de tous les fichiers .ttl à traiter
    turtle_files = list(input_dir.glob("*.ttl"))

    # Application de la limite si elle est définie
    if graph_processing_limit:
        turtle_files = turtle_files[:graph_processing_limit]

    print(f"{len(turtle_files)} fichiers Turtle à traiter dans {input_dir}.")

    # --- ÉTAPE 3 : BOUCLE PRINCIPALE DE TRAITEMENT

    for turtle_photo_file in turtle_files:

        print(f"Début de l'enrichissement pour : {turtle_photo_file.name}")

        try:
            # 1. IMPORT : On transforme le fichier texte en un graphe RDF manipulable
            photo_graph = import_turtle_file(turtle_photo_file)

            # 2. IDENTIFICATION : On trouve les ressources du graphe qui
            # correspondent aux thèmes Rameau associés à la photo
            rameau_themes = get_rameau_themes(photo_graph)

            # 3. RÉCUPÉRATION : On demande à la BnF les labels textuels de ces thèmes Rameau.
            rameau_labels_graph = fetch_themes_labels(rameau_themes, databnf)

            # 4. FUSION : On injecte les labels récupérés dans le graphe de la photo.
            enriched_photo_graph = merge_labels_into_photo_graph(
                photo_graph, rameau_labels_graph
            )

            # 5. CONTRÔLE : On affiche un résumé textuel dans la console
            report = build_summary_report(enriched_photo_graph)
            print(report)

            # 6. EXPORT : On sauvegarde le résultat final sur le disque
            enriched_photo_file = output_dir / turtle_photo_file.name
            export_to_turtle(enriched_photo_graph, enriched_photo_file)

            # Bonus : on exporte aussi une version HTML du graphe enrichi
            # pour pouvoir le visualiser facilement dans un navigateur
            export_graph_to_html(
                enriched_photo_graph, enriched_photo_file.with_suffix(".html")
            )

            print(f"Réussite : {turtle_photo_file.name} enrichi.")

        except Exception as e:
            print(f"Échec pour {turtle_photo_file.name} : {e}")
